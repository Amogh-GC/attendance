<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>College Attendance Dashboard</title>
<link rel="stylesheet" href="public/css/styles.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<script>
// Clear stale localStorage IMMEDIATELY before anything renders
if (localStorage.getItem('userName') === 'asdf') {
  console.log('üßπ Clearing stale localStorage data');
  localStorage.clear();
}
</script>
<header>
  <div class="logo">
    <img src="https://i.postimg.cc/0yBYV4MJ/unnamed-removebg-preview.jpg" alt="Logo">
  </div>
  <div class="header-content">
    <h1>College Attendance Dashboard</h1>
    <p>Indian Institute of Information Technology</p>
  </div>
  <div class="user-menu">
    <div class="user-info">
      <span class="user-name" id="userName">Loading...</span>
      <span class="user-role" id="userRole">...</span>
    </div>
    <a href="/logout" class="logout-btn">
      <i class="fas fa-sign-out-alt"></i>
      Logout
    </a>
  </div>
</header>

<div class="container">
  <div class="class-card" onclick="showAttendance('cs301')">
    <h2>CS301 - Compiler Design</h2>
    <p class="faculty">Faculty: Dr. T. Sugritha</p>
    <div class="progress-container">
      <div class="progress-bar"><div class="progress" id="progress-cs301"></div></div>
      <span class="percentage" id="percent-cs301">0%</span>
    </div>
    <div class="stats-card" id="stats-cs301"></div>
    <div class="attendance-detail" id="cs301"></div>
  </div>

  <div class="class-card" onclick="showAttendance('cs302')">
    <h2>CS302 - Database Management Systems</h2>
    <p class="faculty">Faculty: Dr. M. Ambika</p>
    <div class="progress-container">
      <div class="progress-bar"><div class="progress" id="progress-cs302"></div></div>
      <span class="percentage" id="percent-cs302">0%</span>
    </div>
    <div class="stats-card" id="stats-cs302"></div>
    <div class="attendance-detail" id="cs302"></div>
  </div>
</div>

<script>
// Fetch current user info from server
(function() {
  console.log('üîç Script running - fetching user data...');
  
  // Get DOM elements
  const userNameElement = document.getElementById('userName');
  const userRoleElement = document.getElementById('userRole');
  
  console.log('üìù Elements found:', userNameElement, userRoleElement);
  
  // Fetch user data from the server
  fetch('/api/current-user')
    .then(response => {
      console.log('üì° Response status:', response.status);
      if (!response.ok) {
        throw new Error('Not authenticated');
      }
      return response.json();
    })
    .then(data => {
      console.log('‚úÖ User data received:', data);
      if (data.success && data.user) {
        const userName = data.user.name || 'User';
        const userRole = data.user.role || 'student';
        
        console.log('üë§ Setting userName to:', userName);
        console.log('üé≠ Setting userRole to:', userRole);
        
        // Aggressively update display using multiple methods
        userNameElement.textContent = userName;
        userNameElement.innerHTML = userName;
        userNameElement.innerText = userName;
        
        userRoleElement.textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
        userRoleElement.innerHTML = userRole.charAt(0).toUpperCase() + userRole.slice(1);
        userRoleElement.innerText = userRole.charAt(0).toUpperCase() + userRole.slice(1);
        
        // Force a reflow
        userNameElement.style.display = 'none';
        userNameElement.offsetHeight; // Force reflow
        userNameElement.style.display = '';
        
        // Clear old localStorage and update with new data
        localStorage.clear();
        localStorage.setItem('userName', userName);
        localStorage.setItem('userRole', userRole);
        localStorage.setItem('userId', data.user.id);
        localStorage.setItem('userEmail', data.user.email);
        
        console.log('‚ú® Display updated successfully!');
        console.log('üìä Final userName element:', userNameElement.textContent);
        console.log('üìä Final userRole element:', userRoleElement.textContent);
      }
    })
    .catch(error => {
      console.error('‚ùå Error fetching user data:', error);
      // If not authenticated, redirect to login
      window.location.href = '/login';
    });
})();
</script>

<script src="/public/js/attendance.js"></script>
</body>
</html>
